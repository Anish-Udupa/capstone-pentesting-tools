from .util import run_command
import xml.etree.ElementTree as ET
class zap:
    def __init__(self, ip):
        self.ip = ip
        self.zap_output=[]
    def xml_to_dict(element):
        if len(element) == 0:
            return element.text
        result = {}
        for child in element:
            child_data = xml_to_dict(child)
            if child.tag in result:
                if type(result[child.tag]) is list:
                    result[child.tag].append(child_data)
                else:
                    result[child.tag] = [result[child.tag], child_data]
            else:
                result[child.tag] = child_data
        return result
    def extract_features(self,data):
        xml_string=data
        start = xml_string.find("<alerts>")
        end = xml_string.rfind("</alerts>") + len("</alerts>")
        
        if start != -1 and end != -1:
            xml_content = xml_string[start:end]
            root = ET.fromstring(xml_content)
            result_dict = {root.tag: xml_to_dict(root)}
            st=[]
            for x in result_dict['alerts']['alertitem']:
                if int(x['riskcode'])>=2 and int(x['confidence'])>=2:
                    st.append({'name':x['name'],'desc':x['desc'],'urls':[y['uri'] for y in x['instances']['instance']]})
            if len(st)>0:
                self.zap_output=st
                return True
            else:
                return False
        else:
            return False
    def run(self):
        cmd = f"zaproxy -cmd -silent -quickprogress -quickurl {self.ip}"
        result = run_command(cmd)
        print(result)

        if result['status'] == "success":
            output = result["output"]
            print(output)
        return result
