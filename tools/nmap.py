from .util import run_command
import re
from .generative import GenAi
import ast
class nmap:
    def __init__(self, ip):
        self.ip = ip
        self.port_service_version_list = []
        self.open_ports = []
        self.genai=GenAi()

    def extract_features(self, data):
        query="Return a list of dictionaries containing the following key value pairs: port open, service, and the version."
        return_format='[{"port":"number","service":"service_name","version":"service_version"}]'
        soln=self.genai.get(query,return_format,data)
        soln=ast.literal_eval(soln)
        if len(soln)>0:
            self.port_service_version_list=soln
            return True
        else:
            return False

    def get_open_ports(self, output):
        # re_pattern_port = "([0-9]+)/tcp"
        # ports = re.findall(re_pattern_port, output)
        # self.open_ports = [int(port) for port in ports]
        ret = [int(port_info['port']) for port_info in self.port_service_version_list]
        return ret

    def get_features(self):
        return self.features

    def run(self):
        cmd = f"nmap -sT -A {self.ip}"
        result = run_command(cmd)
        print(result)

        features_success = False
        if result['status'] == 'success':
            output = result["output"]
            features_success = self.extract_features(output)
            
        if features_success is True:
            result['status'] = 'Success'
        else:
            result['status'] = 'failure'
        return result
    
    def get_open_ports(self):
        return self.open_ports
